services:
  app:
    build:
      context: .
    env_file:
      - .env
    environment:
      NODE_ENV: development
      PORT: 8081
      FAKE_OPENAI_MODE: ${FAKE_OPENAI_MODE:-0}
      FAKE_TOOL_PROMPT: ${FAKE_TOOL_PROMPT:-}
      FAKE_TOOL_NAME: ${FAKE_TOOL_NAME:-demo_generate_number}
      FAKE_TOOL_ARGUMENTS: ${FAKE_TOOL_ARGUMENTS:-{"value":10}}
      TOOL_SERVICE_URL: http://agent-service:8090
      ENABLE_MULTI_AGENT: ${ENABLE_MULTI_AGENT:-1}
      AGENT_DEBUG_MODE: ${AGENT_DEBUG_MODE:-1}
    ports:
      - "8081:8081"
    volumes:
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      agent-service:
        condition: service_started
    restart: unless-stopped

  agent-service:
    build:
      context: ./agent-service
    env_file:
      - .env
    environment:
      MCP_GATEWAY_URL: ${MCP_GATEWAY_URL:-http://mcp-gateway:8080}
      MCP_TRANSPORT: ${MCP_TRANSPORT:-streamable-http}
    ports:
      - "8090:8090"
    depends_on:
      mcp-gateway:
        condition: service_started
    restart: unless-stopped

  mcp-gateway:
    image: docker/mcp-gateway:latest
    command:
      - --verbose
      - --transport=streaming
      - --catalog=/mcp-config/catalog.yaml
      - --servers=fetch,node-code-sandbox,memory
      - --port=8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./mcp:/mcp-config:ro
    ports:
      - "8080:8080"
