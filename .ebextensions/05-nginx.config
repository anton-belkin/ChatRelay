files:
  "/etc/nginx/conf.d/01_chatrelay.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Upstream servers
      upstream chatrelay_app {
          server 127.0.0.1:8081;
          keepalive 256;
      }

      # Gzip compression
      gzip on;
      gzip_comp_level 4;
      gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
      gzip_vary on;

      # Increase timeouts for SSE connections
      proxy_read_timeout 3600s;
      proxy_connect_timeout 75s;
      proxy_send_timeout 3600s;

      # Client body size
      client_max_body_size 10M;

      # Keepalive
      keepalive_timeout 65;
      keepalive_requests 100;

      # Server-Sent Events support
      proxy_buffering off;
      proxy_cache off;

  "/etc/nginx/conf.d/02_security.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Security headers
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;

      # Hide nginx version
      server_tokens off;

  "/etc/nginx/conf.d/03_logging.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Custom log format with timing information
      log_format chatrelay_format '$remote_addr - $remote_user [$time_local] '
                                   '"$request" $status $body_bytes_sent '
                                   '"$http_referer" "$http_user_agent" '
                                   'rt=$request_time uct="$upstream_connect_time" '
                                   'uht="$upstream_header_time" urt="$upstream_response_time"';

      access_log /var/log/nginx/access.log chatrelay_format;
      error_log /var/log/nginx/error.log warn;

container_commands:
  01_reload_nginx:
    command: "service nginx reload"
