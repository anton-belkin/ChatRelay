option_settings:
  # Auto Scaling Group Configuration
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 4
    Cooldown: 360

  # Scaling Triggers
  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Statistic: Average
    Unit: Percent
    UpperThreshold: 70
    UpperBreachScaleIncrement: 1
    LowerThreshold: 20
    LowerBreachScaleIncrement: -1
    Period: 5
    BreachDuration: 5
    EvaluationPeriods: 1

  # Update Policy
  aws:autoscaling:updatepolicy:rollingupdate:
    RollingUpdateEnabled: true
    RollingUpdateType: Health
    MinInstancesInService: 1
    MaxBatchSize: 1
    PauseTime: PT5M
    Timeout: PT30M

  # Deployment Policy
  aws:elasticbeanstalk:command:
    DeploymentPolicy: RollingWithAdditionalBatch
    BatchSizeType: Percentage
    BatchSize: 30
    IgnoreHealthCheck: false
    Timeout: 600

Resources:
  # CPU High Alarm
  AWSEBCloudwatchAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Trigger scale up when CPU exceeds 70%"
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 70
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AWSEBAutoScalingGroup
      AlarmActions:
        - Ref: AWSEBAutoScalingScaleUpPolicy

  # CPU Low Alarm
  AWSEBCloudwatchAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Trigger scale down when CPU below 20%"
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 20
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AWSEBAutoScalingGroup
      AlarmActions:
        - Ref: AWSEBAutoScalingScaleDownPolicy

  # Memory High Alarm
  MemoryHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alert when memory usage exceeds 80%"
      MetricName: MEMORY_USED
      Namespace: ChatRelay/Application
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold

  # Disk High Alarm
  DiskHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alert when disk usage exceeds 80%"
      MetricName: DISK_USED
      Namespace: ChatRelay/Application
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
