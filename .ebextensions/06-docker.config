option_settings:
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx

commands:
  01_update_docker_compose:
    command: |
      #!/bin/bash
      # Ensure docker-compose v2 is available
      if ! command -v docker compose &> /dev/null; then
        echo "Installing Docker Compose v2"
        DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
        mkdir -p $DOCKER_CONFIG/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-x86_64 \
          -o $DOCKER_CONFIG/cli-plugins/docker-compose
        chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
      fi
    test: "! command -v 'docker compose' &> /dev/null"

  02_docker_cleanup:
    command: |
      #!/bin/bash
      # Clean up old Docker images to save space
      docker system prune -af --filter "until=168h" || true
    ignoreErrors: true

files:
  "/etc/cron.daily/docker-cleanup":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Daily cleanup of unused Docker resources
      /usr/bin/docker system prune -af --filter "until=168h" --volumes

  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_docker_cleanup.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Cleanup after deployment
      echo "Cleaning up old Docker images..."
      docker image prune -af --filter "until=24h"
      echo "Docker cleanup complete"
