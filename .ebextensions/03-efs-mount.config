option_settings:
  aws:elasticbeanstalk:application:environment:
    EFS_ID: "fs-XXXXXXXX"  # Replace with your EFS File System ID
    EFS_REGION: "us-east-1"  # Replace with your AWS region
    EFS_MOUNT_DIR: "/mnt/efs"

packages:
  yum:
    amazon-efs-utils: []

commands:
  01_mount_efs:
    command: |
      #!/bin/bash
      set -e

      EFS_ID="${EFS_ID:-fs-XXXXXXXX}"
      EFS_REGION="${EFS_REGION:-us-east-1}"
      EFS_MOUNT_DIR="${EFS_MOUNT_DIR:-/mnt/efs}"

      # Create mount directory
      mkdir -p $EFS_MOUNT_DIR

      # Check if already mounted
      if ! mountpoint -q $EFS_MOUNT_DIR; then
        echo "Mounting EFS: $EFS_ID"

        # Mount EFS using TLS
        mount -t efs -o tls,iam $EFS_ID:/ $EFS_MOUNT_DIR

        # Create data directory
        mkdir -p $EFS_MOUNT_DIR/data

        # Set permissions (adjust as needed)
        chmod -R 755 $EFS_MOUNT_DIR/data

        echo "EFS mounted successfully at $EFS_MOUNT_DIR"
      else
        echo "EFS already mounted at $EFS_MOUNT_DIR"
      fi
    test: "[ ! -d /mnt/efs/data ]"

  02_add_fstab_entry:
    command: |
      #!/bin/bash
      EFS_ID="${EFS_ID:-fs-XXXXXXXX}"
      EFS_MOUNT_DIR="${EFS_MOUNT_DIR:-/mnt/efs}"

      # Add to fstab for persistence across reboots
      if ! grep -q "$EFS_ID" /etc/fstab; then
        echo "$EFS_ID:/ $EFS_MOUNT_DIR efs _netdev,tls,iam 0 0" >> /etc/fstab
        echo "Added EFS to /etc/fstab"
      fi
    test: "! grep -q 'fs-' /etc/fstab"

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_verify_efs.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Verify EFS is mounted before deploying

      EFS_MOUNT_DIR="${EFS_MOUNT_DIR:-/mnt/efs}"

      if ! mountpoint -q $EFS_MOUNT_DIR; then
        echo "ERROR: EFS not mounted at $EFS_MOUNT_DIR"
        exit 1
      fi

      if [ ! -d $EFS_MOUNT_DIR/data ]; then
        echo "Creating data directory on EFS"
        mkdir -p $EFS_MOUNT_DIR/data
        chmod -R 755 $EFS_MOUNT_DIR/data
      fi

      echo "EFS verification successful"
      exit 0
